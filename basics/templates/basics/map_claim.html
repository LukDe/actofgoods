{% extends 'basics/base.html' %}

{% block content %}

<style>

	#map-container {
		height: 40%;
	}


</style>
<div class ="row">
<div class="col-md-9">
<!-- Modal -->

<div class="standard-modal" id="location-map-modal">
   		<div class="modal-content">

       		<div class="modal-header">
       			<h2 class="text-center">Which area should be claimed?</h2>
      		</div>
      		<form class= "form" role="form" method="POST" id="post-form">
      		{%csrf_token%}
       		<div class="modal-body">
                <!-- <div class="form-group" id="add-location-alert" style="visibility: hidden;">
					<p id="option"><b>1. Option: </b>The easiest way to get your location is to use the autolocation function.<button id="standard-grey-button-bold" type="button" class="btn btn-primary" style="margin-left: 15px; margin-right: 15px" onclick="getLocation()">Get my Location</button></p>
				</div> -->
				<div class="form-group" id="location-form">
					<p id="option"><b>1. Step(optional): </b>The easiest way to get your location is to use the autolocation function.<button id="standard-grey-button-bold" type="button" class="btn btn-primary" style="margin-left: 15px; margin-right: 15px" onclick="getLocation()">Get my Location</button></p>
				</div>
				<div class="form-group" id="location-form">
					<p id="option"><b>2. Step: </b>Draw your polygon.</p>
					<div id="map-container"></div>
				</div>

			</div><!-- modal-body -->

	        <div class="modal-footer">
				<button id="standard-grey-button-bold" type="button" onclick="loadClaims('0')" class="btn btn-primary">Load All</button>
                <button id="standard-grey-button-bold" type="button" onclick="loadClaims('1')" class="btn btn-primary">Load Own</button>
                <button id="standard-grey-button-bold" type="button" onclick="newClaim()" class="btn btn-primary" >New</button>
                <button id="standard-grey-button-bold" type="submit" class="btn btn-primary" >Save</button>
	        </div>
	        </form>

      	</div><!-- /.modal-content -->
</div><!-- /.modal -->
</div>

<div class="col-md-3">
<!-- Modal -->
<div class="standard-modal" id="claim-modal">
   		<div class="modal-content">

       		<div class="modal-header">
       			<h2 class="text-center">Group Claims</h2>
      		</div>
       		<div class="modal-body" style="max-height: 540px; overflow-y: scroll;">
            <div class="list-group" id="poly-list">
                {% if polyuser %}
                    {% for poly in polyuser %}
                        <!-- list all needs -->
                        <a class="list-group-item" id="standard-list-group-item-div">
                            <div class="row">
                                    <h4 class="list-group-item-heading">{{ poly.pk }}</h4>
                                    <p class="list-group-item-text">Owner: {{poly.claimer}}</p>
                                    <button type="button" class="btn btn-default btn-sml standard-grey-button-light" onclick="deleteClaim({{poly.pk}})" style="float: right; "><span class="glyphicon glyphicon-remove"></span>Delete</button>

                            </div>
                        </a>
                    {% empty %}
                        <h4>There are no needs.</h4>
                    {% endfor %}
                {% endif %}
            </div>

			</div><!-- modal-body -->

	        <div class="modal-footer">
	        </div>
	        </form>

      	</div><!-- /.modal-content -->
</div><!-- /.modal -->
</div>
</div>



<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<!-- Include all compiled plugins (below), or include individual files as needed -->
<script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.no-icons.min.css"></script>
<script src="http://maps.googleapis.com/maps/api/js?key=AIzaSyAmqqg6nhFweM6hPaowtRZT0kRsHPZSaBA"></script>
<script>
function deleteClaim(pk){
	$.ajax({
		url: "delete/",
		type: "POST",
		data: {csrfmiddlewaretoken: '{{ csrf_token }}', pk: pk},

		success: function(json){
            refreshClaim();
			alert(json.result)
		},
		error: function(xhr, errmsg, err){
			console.log(xhr.status + ": " + xhr.responseText);
		},
	});
}

function refreshClaim(){
   $.ajax({
    url: "refresh/",
    type: "POST",
    data: {csrfmiddlewaretoken: '{{ csrf_token }}',},

    success: function(data){
        $('#poly-list').html(data);
        console.log("success");
    },

    error: function(xhr, errmsg, err){
        console.log(xhr.status + ": " + xhr.responseText);
    }
});

}
</script>

<script>
	var map, poly;
	var myCenter=new google.maps.LatLng(51.508742,-0.120850);
	var geocoder;
	var infowindow;
	var marker;
    var path = [];
	var info = new google.maps.InfoWindow();
    var loadedOwn = false;
    var loadedAll = false;
    var onedit=false;


	$('#post-form').on('submit', function(e) {
		pathi=save();
		e.preventDefault();
		console.log("form submitted!");
		$.ajax({
			url: "post/",
			type: "POST",
			data: {csrfmiddlewaretoken: '{{ csrf_token }}', path: pathi},

			success: function(json){
                refreshClaim();
				alert("Succesfully created!");
				poly.setEditable(false);
                onedit=false;
				poly.addListener('click', function(event){
	  				info.setContent('<b>Group: </b>'+'{{group}}'+'<br><b>Owner: </b>' +json.owner + '<br><b>ID: '+json.pk+'</b>');
	  				info.setPosition(event.latLng);
	  				info.open(map);
  				})
				console.log(json);
				console.log("success");
			},

			error: function(xhr, errmsg, err){
				console.log(xhr.status + ": " + xhr.responseText);
			}
		});

	});


    function newClaim(){
        if (onedit==false){
        poly=new google.maps.Polygon({
                paths: new google.maps.MVCArray([new google.maps.MVCArray]),
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 3,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                editable: true
            });
        google.maps.event.addListener(map, 'click', addPoint);
    }
    onedit=true;
    }

	function initialize() {
    	geocoder = new google.maps.Geocoder()
			var mapProp = {
  			center:myCenter,
  			zoom:2,
  			mapTypeId:google.maps.MapTypeId.ROADMAP,
				mapTypeControl: false,
        panControl:false,
        rotateControl:false,
				mapTypeControl:true,
        streetViewControl: false
  		};
  		map = new google.maps.Map(document.getElementById("map-container"),mapProp);
        onedit=true;
  		poly=new google.maps.Polygon({
                paths: new google.maps.MVCArray([new google.maps.MVCArray]),
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 3,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                editable: true
            });
  		google.maps.event.addListener(map, 'click', addPoint);
        /*google.maps.event.addListener(polypoints, 'set_at', function(){
            polygon.paths=polypoints;
            console.log(polygon.getPath());
        })*/
	}

    function loadClaims(prop){
        if (loadedAll==false){
        {% for claim in polygons %}
            path = [];
            {% for point in claim.poly.0 %}
                path.push(new google.maps.LatLng{{point}});
            {% endfor%}
            console.log("Test1");
            createPoly(prop, path, '{{claim.group.name}}','{{claim.claimer.email}}','{{claim.pk}}');
        {%endfor %}
        if(prop=='0'){
            loadedAll=true;
            loadedOwn=true;
        }
        if(prop=='1'){
            loadedOwn=true;
        }

        }
    }

    function createPoly(prop, path, group, email, pk) {
        console.log("Test2"+group);
        if ("{{group}}" == group && loadedOwn==false) {
            console.log("Test3");
        	var claim = new google.maps.Polygon({
                paths: new google.maps.MVCArray(path),
                strokeColor: '#FF0000',
                fillColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 3,
                fillOpacity: 0.35,
                editable: false
            });
            claim.addListener('click', function(event){
            info.setContent('<b>Group: </b>'+group+'<br><b>Owner: </b>' +email + '<br><b>ID: '+pk+'</b>');
            info.setPosition(event.latLng);
            info.open(map);
            })
            claim.setMap(map);
        }

        else{
            if ("{{group}}" != group && prop==0){
            var claim = new google.maps.Polygon({
                paths: new google.maps.MVCArray(path),
                fillColor: '#B8CE52',
                strokeColor: '#71972C',
                strokeOpacity: 0.8,
                strokeWeight: 3,
                fillColor: '#B8CE52',
                fillOpacity: 0.35,
                editable: false
            });
            claim.addListener('click', function(event){
            info.setContent('<b>Group: </b>' + group);
            info.setPosition(event.latLng);
            info.open(map);
            });
            claim.setMap(map);
        }
        }

    }

    function test(){
        //print_polygon();
        save();
    }
                  
	function addPoint(event) {
		if(poly.editable==true){
			poly.getPath().insertAt(poly.getPath().length, event.latLng);
			print_polygon();
			poly.setMap(map);
		}
	}    

    function save() {
        var googleToDjango="";
        for(var i=0;i<poly.getPath().length;i++){
            if(i>0){
                googleToDjango+=", ";
            }
            googleToDjango+=poly.getPath().getAt(i).lat()+" "+poly.getPath().getAt(i).lng();
        }
        googleToDjango+=", "+poly.getPath().getAt(0).lat()+" "+poly.getPath().getAt(0).lng();
        console.log(JSON.stringify(googleToDjango));
        return googleToDjango;
    }

    function print_polygon(){
    	console.log("Neues Poly! LÃ¤nge: " + poly.getPath().length);
        for (var i=0; i<poly.getPath().length; i++){
            console.log(poly.getPath().getAt(i).lat());
        }
    }

    function placePolygon(event){
        if(poly){
            placeMarker(event);
            var index=paths.length;
            paths.push(event.latLng);
            poly.setPaths(paths);
            //google.maps.event.addListener(poly.getPath().getAt(index), 'set_at', print_polygon());
        }
        else if(!poly){
                placeMarker(event);
                paths.push(event.latLng);
                poly=new google.maps.Polygon({
                paths: paths,
                strokeColor: '#FF0000',
                strokeOpacity: 0.8,
                strokeWeight: 3,
                fillColor: '#FF0000',
                fillOpacity: 0.35,
                editable: false
            });
        } else {
            paths=poly.getPaths();
        }poly.setMap(map);
    }

	function getLocation() {
    	if (navigator.geolocation) {
    	    navigator.geolocation.getCurrentPosition(showPosition);
    	} else {
    	    x.innerHTML = "Geolocation is not supported";
    	    y.innerHTML = "by this browser.";
    	}
	}

	function showPosition(position) {
    	var latlng={lat: parseFloat(position.coords.latitude), lng: parseFloat(position.coords.longitude)};
    	placeMarker(latlng);
	}


	function placeMarker(location) {
	    if(marker){
	        infowindow.close();
	        marker.setPosition(location);
	        geocoder.geocode({'location': location}, function(results, status){
	            infowindow.setContent(results[0].formatted_address);
	            infowindow.open(map,marker);
	        })
	    }
	    else{
	        marker = new google.maps.Marker({
	        position: location,
	        map: map,
	        });
	        geocoder.geocode({'location': location}, function(results, status){
	            infowindow = new google.maps.InfoWindow({content: results[0].formatted_address});
	            infowindow.open(map,marker);
	        })
	       	map.setZoom(6);
	    }
		map.setCenter(marker.getPosition());
	}
	google.maps.event.addDomListener(window, 'load', initialize);


</script>
<script type='text/javascript'>
 	$('#location-map-modal').on('shown.bs.modal', function(e) {
        initialize();
    });

</script>

{% endblock %}