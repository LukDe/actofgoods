{% extends 'basics/base.html' %}

{% block content %}
{% load filter %}
{% load staticfiles %}



    <link rel="stylesheet" href="{% static 'basics/css/styles.css' %}"/>
    <script src="https://fb.me/react-15.0.2.js"></script>
    <script src="https://fb.me/react-dom-15.0.2.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.8.34/browser.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>

  <body>
  <!--<div class = "row " style="min-height: 500px; box-shadow: 0 0 30px black; height:70%; border-radius: 1em;" >-->


    <div class="row">
      <div class="container col-md-4" >
        <div id="standart-modal"  >
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">Your Chats</h4>
            </div>
            <div class="modal-body">
              <div id="rooms-container">
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-8 col-xs-12 shadow-small" >
        <div id="standart-modal"  >
          <div class="modal-content">
            <div class="modal-header">
              <h4 class="modal-title">{{ roomname }}</h4>
            </div>
            <div class="modal-body">
              <div id="app">
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  <script type="text/babel">
'use strict';

(function (React, ReactDOM, window, document, MDL) {
  'use strict';

  var LoadingBar = function LoadingBar(props) {
    return React.createElement('div', { className: 'mdl-progress mdl-js-progress mdl-progress__indeterminate' });
  };


  var Message = function Message(props) {
    var classString = props.ownMessage ? 'own message__text' : 'message__text';
    var classString = props.systemMessage ? 'system ':classString;
    var longClassString = classString + "text-center message clearfix"
    var user = props.ownMessage ? 'Own' : 'Other '
    var user = props.systemMessage? '': user
    return (
      <div className={longClassString}>
        <div className="message__author">
          {user}
        </div>
        <div className={classString}>
          {props.text}
          <div className="small-text">
            {props.date}
          </div>
        </div>
      </div>
    );
  };

  var MessageList = React.createClass({
    displayName: 'MessageList',


    componentDidUpdate: function componentDidUpdate() {
      this.messageList.scrollTop = this.messageList.scrollHeight;
    },

    getNodeRef: function getNodeRef(ref) {
      this.messageList = ref;
    },

    render: function render() {
      return (/*React.createElement(
          'div',
          { className: 'message-list', ref: this.getNodeRef},
          this.props.children
       );*/

        <div className="message-list" ref={this.getNodeRef}>
          {this.props.children}
        </div>
      );
    }
  });

  var InputSection = function InputSection(props) {
    var firstClass = "clearfix";
    return (
      <div className={firstClass}>
        <div className="form-group">
        <div>
          <textarea onKeyDown= {props.handleKeyDown}
          className= 'form-control input-lg'
          type= 'text'
          id= 'chat-input'
          value= {props.inputValue}
          onChange= {props.handleChange}
          onBlur= {props.handleBlur}/>
        </div>
        </div>
        <div className="float-right button-container">
          <button onClick={props.handleClick}
          className= 'btn btn-primary'
          type= 'submit' >
          {props.buttonText}
          </button>
        </div>
      </div>
    );
    React.createElement(
      'div',
      { className: props.specificClass + ' clearfix' },
      React.createElement(
        'div',
        { className: 'mdl-textfield mdl-js-textfield mdl-textfield--floating-label float-left' },
        React.createElement('input', {
          onKeyDown: props.handleKeyDown,
          className: 'mdl-textfield__input',
          type: 'text',
          id: 'chat-input',
          value: props.inputValue,
          onChange: props.handleChange,
          onBlur: props.handleBlur }),
        React.createElement(
          'label',
          { className: 'mdl-textfield__label' },
          props.labelText
        )
      ),
      React.createElement(
        'div',
        { className: 'float-right button-container' },
        React.createElement(
          'button',
          {
            onClick: props.handleClick,
            className: 'btn btn-primary',
            type: 'submit' },
          props.buttonText
        )
      )
    );
  };


  var MessageEditor = React.createClass({
    displayName: 'MessageEditor',


    getInitialState: function getInitialState() {
      return {
        message: ''
      };
    },

    handleChange: function handleChange(e) {
      this.setState({
        message: e.target.value
      });
    },

    sendMessage: function sendMessage(e) {
      this.props.sendMessage(this.state.message);
      this.setState({
        message: ''
      });
    },

    handleKeyDown: function handleKeyDown(e) {
      switch (e.keyCode) {
        case 13:
          e.preventDefault();
          if (this.state.message === '') {
            return;
          }
          this.sendMessage();
          break;
        default:
          return;
      }
    },

    render: function render() {
      return React.createElement(InputSection, {
        specificClass: 'form-container',
        handleKeyDown: this.handleKeyDown,
        inputValue: this.state.message,
        handleChange: this.handleChange,
        labelText: 'Enter your message...',
        handleClick: this.sendMessage,
        buttonText: 'Send message'
      });
    }

  });


  var ChatContainer = React.createClass({
    displayName: 'ChatContainer',


    getInitialState: function getInitialState() {
      console.log({{messages|safe}})
      return {
        channel: '{{roomname}}'||'Actofgoods',
        connected: false,
        messages: {{messages|safe}},
        author: '',
        name:'{{name}}'
      };
    },

    socket: null,

    createSocket: function createSocket() {

      var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
      var url = ws_scheme + '://' + window.location.host + "/chat/" + this.state.channel + '?username=' + this.state.author;
      this.socket = new WebSocket(url);

      window.chatSocket = this.socket;

      this.socket.addEventListener('message', function (e) {
        this.sendMessage("ack");
        console.log("ack for message "+ JSON.parse(e.data));
        this.setState({
          messages: this.state.messages.concat(JSON.parse(e.data))
        });
      }.bind(this));

      this.socket.addEventListener('open', function () {
        this.setState({
          connected: true
        });
      }.bind(this));

      this.socket.addEventListener('close', function () {
        this.setState({
          connected: false
        }, this.createSocket);
      }.bind(this));
    },

    closeSocket: function closeSocket() {
      this.socket.close();
    },

    componentWillMount: function componentWillMount() {
      var author = '{{request.user.username}}';
      this.setState({
        author: author
      });
    },

    componentDidMount: function componentDidMount() {
      this.createSocket();

      this.chatBox.querySelector('.message-list').style.bottom = this.chatBox.querySelector('.actions-containers').offsetHeight + 'px';

      window.addEventListener('resize', function () {
        this.chatBox.querySelector('.message-list').style.bottom = this.chatBox.querySelector('.actions-containers').offsetHeight + 'px';
      }.bind(this));

      MDL.upgradeDom();
    },

    componentDidUpdate: function componentDidUpdate() {
      this.chatBox.querySelector('.message-list').style.bottom = this.chatBox.querySelector('.actions-containers').offsetHeight + 'px';

      MDL.upgradeDom();
    },

    sendMessage: function handleMessageSend(message) {
      this.socket.send(message);
    },

    handleChatChange: function handleChatChange(newChannelName) {
      if (newChannelName === this.state.channel) {
        return;
      }
      this.setState({
        messages: [],

        channel: newChannelName
      }, this.closeSocket);
    },

    sendNumber: function sendNumber(number) {
      if(this.socket != null){
        this.sendMessage(number);
      };
    },

    getNodeRef: function getNodeRef(ref) {
      this.chatBox = ref;
    },

    render: function render() {
      var messages = this.state.messages.map(function (message, index) {
        return React.createElement(Message, {
          ownMessage: message.username === this.state.author ? true : false,
          systemMessage: message.username === 'null',
          text: message.message,
          author: message.username,
          date: message.date,
          key: index });
      }.bind(this));
      console.log(messages);
      var visibilityClass = !this.state.connected ? 'hidden' : '';
      return (
        <div className="mdl-cell--stretch" ref={this.getNodeRef}>
          {!this.state.connected ? React.createElement(LoadingBar, null) : null}
          <div>
            <h4>{this.state.name}</h4>
            <a id="standard-grey-button-bold" className="btn btn-primary btn-kick" href="{% url 'basics:kick_user' roomname=roomname %}">
              {% if roomname|is_own:request.user %} 'Kick User' {% else %} 'leave' {% endif %}
            </a>
            <a id="standard-grey-button-bold" className="btn btn-primary btn-kick" onClick={this.sendNumber.bind(null, 'number')}>
              Send Number
            </a>
          </div>
          <MessageList>
            {messages}
          </MessageList>
          <div className="actions-containers ">
            <MessageEditor sendMessage={this.sendMessage}>

            </MessageEditor>
          </div>
        </div>
      );/*
      return React.createElement(
        'div',
        { className: ' mdl-cell--stretch', ref: this.getNodeRef },
        !this.state.connected ? React.createElement(LoadingBar, null) : null,
        React.createElement(
          'div',
          {},
          React.createElement(
            'h4',
            {},
            this.state.name
          ),
          React.createElement(
            'a',
            {id:'standard-grey-button-bold', className:'btn btn-primary btn-kick', href:'{% url 'basics:kick_user' roomname=roomname %}'},
            {% if roomname|is_own:request.user %} 'Kick User' {% else %} 'leave' {% endif %}
          ),
          React.createElement(
            'a',
            {id:'standard-grey-button-bold', className:'btn btn-primary btn-kick', onClick:this.sendNumber.bind(null, 'number')},
            'Send Number'
          )
        ),
        React.createElement(
          MessageList,
          null,
          messages
        ),
        React.createElement(
          'div',
          { className: 'actions-containers mdl-shadow--3dp ' + visibilityClass },
          /*React.createElement(ChannelSelector, {
            currentChannel: this.state.channel,
            handleChatChange: this.handleChatChange }),
          React.createElement(MessageEditor, { sendMessage: this.sendMessage })
        )
      );*/
    }

  });

  var Room = function Room(props){
    var href = "/chat/"+props['room']['hash'];
    return (
      <a className="goupe-list-element" id="standard-list-group-item-div" href={href}>
        <div className="row">
        <div className="col-sm-11 grey room" id="standart-modal">
          <div>
            <div className="card card-block">
              <h3 className="card-title">{props['room']['name']} </h3>
              <p className="card-text"> {props['room']['date']} </p>
            </div>
          </div>
        </div>
        </div>
      </a>
    );
    /*React.createElement(
      'a',
      {className:'goupe-list-element ', id:'standard-list-group-item-div', href:"/chat/"+props['room']['hash'] },
      React.createElement(
        'div',
          {className:'col-sm-11 grey room',  id:'standart-modal'},
        React.createElement(
          'div',
          {className:''},
          React.createElement(
            'div',
            {className:'card card-block'},
            React.createElement(
              'h3',
              {className:'card-title'},
              props['room']['name']
            ),
            React.createElement(
              'p',
              {className:'card-text'},
              props['room']['date']
            )
          )
        )
      )
    );
    */
  };
  var RoomsContainer = React.createClass({
    displayName: 'RoomsContainer',

    getInitialState: function getInitialState() {
      var rooms = eval({{rooms_json|safe}})
      console.log(rooms)
      var ws_scheme = window.location.protocol == "https:" ? "wss" : "ws";
      for(var i=0;i<rooms.length;i++){
        name = rooms[i]['hash'];
        console.log(name);
        var url = ws_scheme + '://' + window.location.host + "/chat/" + name + '?username={{request.user.username}}';
        var socket = new WebSocket(url);

        socket.onmessage = function(message) {
            var j = 0;
            var room = JSON.parse(message.data)['room'];
            for(j=0;j<rooms.length;j++){
              console.log(rooms[j]['hash'], room);
              if(rooms[j]['hash'] === room){
                //TODO: Change value of date; we need some sort of flag for messages if they where read
                break;
              }
            };

            rooms.unshift(rooms.splice(j,1)[0]);
            console.log(rooms);
            this.setState({
              rooms:rooms
            });
        }.bind(this);
      }
      return {
        rooms: rooms
      };
    },


    render: function render() {
      var rendered_rooms = []
      for(var i =0;i<this.state.rooms.length;i++){
        rendered_rooms.push(React.createElement(Room, {key:i, room:this.state.rooms[i], handleClick:this.handleClick}))
      }
      return (
        <div className="room-container" ref={this.getNodeRef}>
          {rendered_rooms}
        </div>
      );/*React.createElement(
        'div',
        { className: 'room-container room-container-small', ref: this.getNodeRef },
        rendered_rooms
      );*/

    }
  })
  //Initialisiere 2 Chats

  var App = React.createClass({
    displayName: 'App',

    getInitialState: function getInitialState() {
      return {
        chats: 1,
        chatContainer: null
      };
    },

    alert_some : function alert_some(){
    },

    render: function render() {
      this.state.chatContainer = React.createElement(ChatContainer, { key: 0 });
      return (
        <div>
          {this.state.chatContainer}
        </div>
      );//React.createElement('div',{ className: '' } ,this.state.chatContainer);
    }
  });

  ReactDOM.render(React.createElement(App, null), document.getElementById('app'));
  ReactDOM.render(React.createElement(RoomsContainer, null), document.getElementById('rooms-container'));
})(React, ReactDOM, window, document, componentHandler);

  window.onbeforeunload = function(){
    var val = $("#chat-input").val();
    console.log(val);
    if($("#chat-input").val() != ""){
      return 'Are you sure you want to leave?';
    }
  };
</script>



</script>
  </body>

{% endblock %}
